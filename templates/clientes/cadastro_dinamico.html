<!--templates/clientes/cadastro_dinamico.html-->

{% load widget_tweaks %}
{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{{ page_title|default:"Novo Cadastro" }} - {{ site_config.nome_empresa|default:"Lider Drive" }}</title>
    <style>
        /* --- ESTILOS VISUAIS --- */
        body { font-family: sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px;}
        .container { max-width: 900px; margin: 20px auto; background-color: #fff; padding: 2.5rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .branding { display: flex; flex-direction: column; align-items: center; margin-bottom: 2rem; }
        .branding img { width: auto; margin-bottom: 15px; max-height: 100px; max-width: 250px;}
        .branding .auth-title { color: #0056b3; font-size: 1.5em; font-weight: bold; margin: 0; }
        
        fieldset { border: 1px solid #ccc; border-radius: 4px; padding: 20px; margin-bottom: 20px; }
        legend { font-weight: bold; font-size: 1.2em; color: #0056b3; padding: 0 10px; }
        
        /* Grids padronizadas */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .verificacao-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 700px; margin: 10px auto; }
        
        .form-row { display: flex; flex-direction: column; }
        .form-row label { font-size: 0.9em; margin-bottom: 5px; color: #555; font-weight: bold; text-align: left; }
        .form-row input, .form-row select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .submit-row { text-align: center; margin-top: 20px; }
        .submit-row button { padding: 12px 30px; font-size: 1.1em; background-color: #38a169; color: white; border: none; border-radius: 44px; cursor: pointer; font-weight: bold; }
        
        .full-width { grid-column: 1 / -1; }
        .uppercase-input { text-transform: uppercase; }
        .lowercase-input { text-transform: lowercase; }

        .legenda-obrigatorios { font-size: 0.85em; color: #888; text-align: left; margin: 10px 0 20px 0; padding-left: 20px; }
        .legenda-obrigatorios strong { color: #d9534f; font-weight: bold; }

        .label-container { display: flex; justify-content: flex-start; align-items: baseline; }
        .validation-message { font-size: 0.85em; font-weight: bold; margin-left: 10px; color: red; display: inline; }
        .errorlist { color: red; list-style: none; padding: 0; margin: 0 0 0 10px; font-size: 0.85em; font-weight: bold; display: inline; }
        
        /* Estilos de Verificação */
        #bloco_verificacao { text-align: center; }
        #bloco_verificacao .form-row input { max-width: 350px; margin: 10px auto; text-align: center; font-size: 1.1em; padding: 12px; width: 100%; }
        #bloco_verificacao .submit-row button { background-color: #0056b3; }
        #bloco_verificacao .submit-row button:disabled { background-color: #ccc; cursor: not-allowed; }

        #verificacao_resultado { display: none; padding: 15px; margin: 20px auto; max-width: 80%; border-radius: 4px; font-weight: bold; text-align: center; line-height: 1.6; }
        .resultado-sucesso { background-color: #d4edda; color: #155724; }
        .resultado-aviso { background-color: #fff3cd; color: #856404; }
        .resultado-erro { background-color: #f8d7da; color: #721c24; }
        
        .hidden-form { display: none; }
        
        /* Responsividade para a verificação */
        @media (max-width: 600px) { .verificacao-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="container">
        <form method="POST" id="form_cadastro_principal">
            {% csrf_token %}
            
            <div class="branding">
                {# [MARCA DINÂMICA] Logo da Empresa #}
                {% if site_config and site_config.logo %}
                    <img src="{{ site_config.logo.url }}" alt="Logotipo {{ site_config.nome_empresa|default:"Lider Drive" }}">
                {% else %}
                    <img src="{% static 'logo.png' %}" alt="Logotipo Lider Drive">
                {% endif %}
                
                <p class="auth-title">NOVO CADASTRO</p>
            </div>

            <fieldset id="bloco_verificacao">
                <legend>Identificação</legend>
                
                <div class="verificacao-grid">
                    <div class="form-row">
                        <label for="documento_input" style="text-align: center;">CPF ou CNPJ</label>
                        <input type="text" id="documento_input" name="documento_input" placeholder="000.000.000-00">
                        <span id="doc_validation_message" class="validation-message" style="margin: 5px auto 0 auto;"></span>
                    </div>
                    
                    <div class="form-row">
                        <label for="email_input" style="text-align: center;">Seu E-mail</label>
                        <input type="email" id="email_input" name="email_input" placeholder="seuemail@dominio.com" class="lowercase-input">
                        <span id="email_validation_message" class="validation-message" style="margin: 5px auto 0 auto;"></span>
                    </div>
                </div>

                <div class="submit-row">
                    <button type="button" id="btn_verificar_doc">Verificar</button>
                </div>
            </fieldset>
            
            <div id="verificacao_resultado"></div>

            <div id="form_cadastro_completo" class="hidden-form">
                
                <fieldset>
                    <legend>Dados Pessoais (Formulário PF)</legend>
                    
                    {% if form.non_field_errors %}
                        {% for error in form.non_field_errors %}
                            <p class="errorlist" style="text-align: center; background-color: #ffdddd; padding: 10px; border-radius: 4px; display: block;">{{ error }}</p>
                        {% endfor %}
                    {% endif %}

                    
                    {# Aqui vai todo o miolo do formulário FichaCadastralClienteForm #}
                    <div class="form-grid">
                        <div class="form-row full-width">
                            <label for="{{ form.nome_completo.id_for_label }}">{{ form.nome_completo.label }}:</label>
                            {% render_field form.nome_completo class+="form-control uppercase-input" %}
                        </div>
                        <div class="form-row">
                            <label for="{{ form.data_nascimento.id_for_label }}">{{ form.data_nascimento.label }}:</label>
                            {% render_field form.data_nascimento class+="form-control date-mask" %}
                        </div>
                        <div class="form-row">
                            <label for="{{ form.cpf.id_for_label }}">{{ form.cpf.label }}:</label>
                            {% render_field form.cpf class+="form-control cpf-mask" readonly="readonly" %}
                        </div>
                        <div class="form-row">
                            <label for="{{ form.rg.id_for_label }}">{{ form.rg.label }}:</label>
                            {% render_field form.rg class+="form-control uppercase-input" %}
                        </div>
                        <div class="form-row">
                            <label for="{{ form.rg_orgao_expeditor.id_for_label }}">{{ form.rg_orgao_expeditor.label }}:</label>
                            {% render_field form.rg_orgao_expeditor class+="form-control uppercase-input" %}
                        </div>
                        <div class="form-row">
                            <label for="{{ form.rg_uf.id_for_label }}">{{ form.rg_uf.label }}:</label>
                            {% render_field form.rg_uf class+="form-control" %}
                        </div>
                        <div class="form-row">
                            <label for="{{ form.estado_civil.id_for_label }}">{{ form.estado_civil.label }}:</label>
                            {% render_field form.estado_civil class+="form-control" %}
                        </div>
                        <div class="form-row full-width">
                            <label for="{{ form.nome_mae.id_for_label }}">{{ form.nome_mae.label }}:</label>
                            {% render_field form.nome_mae class+="form-control uppercase-input" %}
                        </div>
                        <div class="form-row full-width">
                            <label for="{{ form.nome_pai.id_for_label }}">{{ form.nome_pai.label }}:</label>
                            {% render_field form.nome_pai class+="form-control uppercase-input" %}
                        </div>
                    </div>
                    
                    <fieldset style="margin-top: 20px;">
                        <legend>Contato Adicional</legend>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-row">
                                <label for="{{ form.email.id_for_label }}">{{ form.email.label }}:</label>
                                {% render_field form.email class+="form-control" readonly="readonly" %}
                            </div>
                            <div class="form-row">
                                <label for="{{ form.email_confirm.id_for_label }}">{{ form.email_confirm.label }}:</label>
                                {% render_field form.email_confirm class+="form-control" %}
                            </div>
                            <div class="form-row">
                                <label for="{{ form.celular.id_for_label }}">{{ form.celular.label }}:</label>
                                {% render_field form.celular class+="form-control phone-mask-celular" %}
                            </div>
                            <div class="form-row">
                                <label for="{{ form.telefone.id_for_label }}">{{ form.telefone.label }}:</label>
                                {% render_field form.telefone class+="form-control phone-mask-fixo" %}
                            </div>
                        </div>
                    </fieldset>

                    <p class="legenda-obrigatorios">Campos com <strong>(*)</strong> são de preenchimento obrigatório.</p>
                </fieldset>
            
                <div class="submit-row" style="text-align: center; margin-top: 30px;">
                    <button type="submit" id="submit_button">Criar Conta e Validar E-mail</button>
                </div>
            </div> </form>

        <div class="back-link">
            <a href="{% url 'home' %}">Voltar para o Início</a>
        </div>
    </div>
    
    {# --- SCRIPTS DE MÁSCARA (NO FIM DO BODY) --- #}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="{% static 'js/mask.js' %}"></script>
    <script>
        $(document).ready(function() {
            
            // --- VARIÁVEL DE ESTADO (PARA RECARGA DE ERRO) ---
            var showFlagString = "{{ show_form_on_load|default:'false'|lower }}";
            var showFormOnLoad = (showFlagString === 'true');

            // --- LÓGICA DE RECARGA ---
            if (showFormOnLoad) {
                $('#bloco_verificacao').hide();
                $('#form_cadastro_completo').show();
                
                // Reaplica readonly/tabindex nos campos preenchidos pelo POST
                var campoCpfLegado = $('#{{ form.cpf.id_for_label }}');
                campoCpfLegado.prop('readonly', true).attr('tabindex', -1).mask('000.000.000-00');
                
                var campoEmailLegado = $('#{{ form.email.id_for_label }}');
                campoEmailLegado.prop('readonly', true).attr('tabindex', -1);
            }
            
            // --- 1. REFERÊNCIAS E MÁSCARA (Verificação Inicial) ---
            var documentoInput = $('#documento_input');
            var emailInput = $('#email_input');
            var docValidationMessage = $('#doc_validation_message');
            var emailValidationMessage = $('#email_validation_message');
            var btnVerificar = $('#btn_verificar_doc');
            var resultadoDiv = $('#verificacao_resultado');
            var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            var options = {
                onKeyPress: function(doc, e, field, options) {
                    var masks = ['000.000.000-009', '00.000.000/0000-00'];
                    var mask = (doc.length > 14) ? masks[1] : masks[0];
                    documentoInput.mask(mask, options);
                }
            };
            documentoInput.mask('000.000.000-009', options);
            btnVerificar.prop('disabled', true); 

            // ... (Lógica de validação silenciosa) ...
            function validarCampos() {
                var doc = documentoInput.val().replace(/\D/g, '');
                var email = emailInput.val();
                var docValido = (doc.length == 11 || doc.length == 14);
                var emailValido = emailRegex.test(email);

                if (docValido && emailValido) {
                    btnVerificar.prop('disabled', false);
                } else {
                    btnVerificar.prop('disabled', true);
                }
                docValidationMessage.text('');
                emailValidationMessage.text('');
            }
            documentoInput.on('input keyup', validarCampos);
            emailInput.on('input keyup', validarCampos);

            // --- BLOQUEIA 'COLAR' ---
            $('#{{ form.email_confirm.id_for_label }}').on('paste', function(e) {
                e.preventDefault();
                var msgSpan = $('#email_confirm_validation_message');
                msgSpan.text('Colar não é permitido.');
                setTimeout(function() { msgSpan.text(''); }, 2000);
            });

            // --- 3. LÓGICA AJAX (VERIFICAÇÃO) ---
            function resetResultado() { resultadoDiv.hide().text('').removeClass('resultado-sucesso resultado-aviso resultado-erro'); }
            function showResultado(tipo, mensagemHtml) { resetResultado(); resultadoDiv.addClass('resultado-' + tipo).html(mensagemHtml).slideDown(); }

            btnVerificar.on('click', function() {
                var documento = documentoInput.val();
                var email = emailInput.val();
                var docLimpo = documento.replace(/\D/g, '');
                var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
                
                resetResultado(); 
                docValidationMessage.text('');
                emailValidationMessage.text('');

                var camposOk = true;
                if (docLimpo.length !== 11 && docLimpo.length !== 14) {
                    docValidationMessage.text('CPF ou CNPJ incompleto');
                    camposOk = false;
                }
                if (!emailRegex.test(email)) {
                    emailValidationMessage.text('Formato de e-mail inválido');
                    camposOk = false;
                }
                if (!camposOk) { return; }
                
                btnVerificar.prop('disabled', true).text('Verificando...');

                $.ajax({
                    url: "{% url 'clientes:verificar_documento_ajax' %}",
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ 'documento': documento, 'email': email }),
                    headers: { 'X-CSRFToken': csrfToken },
                    
                    success: function(response) {
                        
                        if (response.status === 'exists') {
                            showResultado('aviso', response.message);
                            btnVerificar.text('Verificar'); 
                        
                        } else if (response.status === 'not_found' && response.doc_type === 'cpf') {
                            showResultado('sucesso', 'CPF e e-mail válidos. Por favor, complete seu cadastro abaixo.');
                            $('#bloco_verificacao').slideUp();
                            
                            // Preenche e trava campos PF
                            var campoCpfLegado = $('#{{ form.cpf.id_for_label }}');
                            campoCpfLegado.val(documento).prop('readonly', true).attr('tabindex', -1).mask('000.000.000-00');
                            
                            var campoEmailLegado = $('#{{ form.email.id_for_label }}');
                            campoEmailLegado.val(email).prop('readonly', true).attr('tabindex', -1);
                            
                            $('#{{ form.email_confirm.id_for_label }}').val('').prop('readonly', false);
                            
                            $('#form_cadastro_completo').slideDown();
                        
                        } else if (response.status === 'not_found_pj') {
                            showResultado('sucesso', 'CNPJ e e-mail válidos. O cadastro para Pessoa Jurídica será liberado em breve!');
                            btnVerificar.text('Verificar').prop('disabled', false);
                        
                        } else {
                            showResultado('erro', response.message || 'Erro desconhecido.');
                            btnVerificar.text('Verificar').prop('disabled', false);
                        }
                    },
                    error: function(xhr) {
                        let errorMsg = 'Ocorreu um erro ao verificar os dados.';
                        if (xhr.responseJSON && xhr.responseJSON.message) { errorMsg = xhr.responseJSON.message; }
                        showResultado('erro', errorMsg);
                        btnVerificar.text('Verificar').prop('disabled', false);
                    }
                });
            });
        });
        
        // --- FUNÇÃO DE VALIDAÇÃO JS LEGADO (Nomes) ---
        function validarNome(inputId, errorSpanId, mensagemErro) {
            const inputElement = document.getElementById(inputId);
            if (!inputElement) return; 
            const errorElement = document.getElementById(errorSpanId);
            const nome = inputElement.value.trim();

            errorElement.textContent = ''; 
            if (nome === '') { return; } 
            if (nome.includes('.')) {
                errorElement.textContent = "Nome não pode conter pontos (.).";
                return;
            }
            const partes = nome.split(' ').filter(part => part !== '');
            if (partes.length < 2) {
                errorElement.textContent = mensagemErro;
            }
        }
    </script>


    <style>
        /* [ATENÇÃO] Este bloco de estilos é usado para grids no modo desktop */
        .ficha-form fieldset { border: 1px solid #ccc; border-radius: 4px; padding: 20px; margin-bottom: 25px; text-align: left;}
        .ficha-form legend { font-weight: bold; font-size: 1.2em; color: #0056b3; padding: 0 10px; margin-left: -5px;}
        .ficha-form .form-row { display: flex; flex-direction: column; }
        .ficha-form .form-row label { font-size: 0.9em; margin-bottom: 5px; color: #555; font-weight: bold; }
        .ficha-form .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .ficha-form .submit-button { padding: 12px 30px; font-size: 1.1em; background-color: #38a169; color: white; border: none; border-radius: 44px; cursor: pointer; font-weight: bold; }
        .ficha-form .full-width { grid-column: 1 / -1; }
        .ficha-form .errornote { color: red; margin-bottom: 10px; padding: 10px; border: 1px solid red; border-radius: 4px; }
        .ficha-form .errorlist { color: red; list-style: none; padding-left: 0; margin-top: 5px; font-size: 0.85em; font-weight: bold; }

        .form-grid-1-col { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .form-grid-2-col { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .form-grid-3-col { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .form-grid-4-col { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .form-grid-endereco { display: grid; grid-template-columns: 1fr 1fr 0.5fr 0.5fr; gap: 20px; } 

        /* Responsividade para Formulário: Transforma para 1 coluna no mobile */
        @media (max-width: 600px) {
            .form-grid-3-col, .form-grid-2-col, .form-grid-endereco {
                grid-template-columns: 1fr;
            }
            .ficha-form .full-width { grid-column: 1 / 1; }
        }
    </style>
{% endblock content %}